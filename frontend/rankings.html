<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Leaderboard - All Classes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="rankings.css">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="trophy-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                            <path d="M4 22h16"></path>
                            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1>Teacher Leaderboard</h1>
                        <p>All Classes â€¢ Academic Performance Rankings</p>
                    </div>
                </div>
                <div class="header-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="stat-value" id="totalTeachers">0</div>
                            <div class="stat-label">Total Teachers</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                        </div>
                        <div>
                            <div class="stat-value" id="totalTests">0</div>
                            <div class="stat-label">Total Tests</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                        </div>
                        <div>
                            <div class="stat-value" id="totalClasses">0</div>
                            <div class="stat-label">Total Classes</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="spinner-large"></div>
            <p>Loading leaderboard data...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <h3>Failed to Load Data</h3>
            <p id="errorMessage">Unable to fetch leaderboard data</p>
            <button class="retry-btn" onclick="location.reload()">Retry</button>
        </div>

        <!-- Top 3 Podium -->
        <div id="podium" class="podium" style="display: none;">
            <div class="podium-item second" id="rank2">
                <div class="podium-rank">2</div>
                <div class="podium-avatar silver">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h3 class="podium-name">-</h3>
                <div class="podium-tests">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span>0 tests</span>
                </div>
                <div class="podium-subjects">
                    <span class="subject-badge">N/A</span>
                </div>
                <div class="podium-classes">
                    <span class="class-badge">N/A</span>
                </div>
                <div class="podium-stand silver-stand">
                    <div class="stand-label">2nd</div>
                </div>
            </div>

            <div class="podium-item first" id="rank1">
                <div class="podium-rank winner">1</div>
                <div class="crown">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2 12l3-3 4 4 4-8 4 8 4-4 3 3v8H2z"></path>
                    </svg>
                </div>
                <div class="podium-avatar gold">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h3 class="podium-name">-</h3>
                <div class="podium-tests">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span>0 tests</span>
                </div>
                <div class="podium-subjects">
                    <span class="subject-badge">N/A</span>
                </div>
                <div class="podium-classes">
                    <span class="class-badge">N/A</span>
                </div>
                <div class="podium-stand gold-stand">
                    <div class="stand-label">1st</div>
                </div>
            </div>

            <div class="podium-item third" id="rank3">
                <div class="podium-rank">3</div>
                <div class="podium-avatar bronze">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h3 class="podium-name">-</h3>
                <div class="podium-tests">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span>0 tests</span>
                </div>
                <div class="podium-subjects">
                    <span class="subject-badge">N/A</span>
                </div>
                <div class="podium-classes">
                    <span class="class-badge">N/A</span>
                </div>
                <div class="podium-stand bronze-stand">
                    <div class="stand-label">3rd</div>
                </div>
            </div>
        </div>

        <!-- Full Rankings Table -->
        <div id="rankingsTable" class="rankings-section" style="display: none;">
            <h2 class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                Complete Rankings
            </h2>
            <div class="rankings-list" id="rankingsList"></div>
        </div>
    </div>

    <script type="module">
        import { databases, DATABASE_ID, COLLECTION_ID } from './config/appwrite.js';

        async function loadLeaderboard() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const podium = document.getElementById('podium');
            const rankingsTable = document.getElementById('rankingsTable');

            try {
                // Fetch ALL tests from ALL classes
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    COLLECTION_ID
                );

                const tests = response.documents;

                // Group tests by teacher
                const teacherStats = {};
                const allClasses = new Set();
                
                tests.forEach(test => {
                    const teacher = test.teacher;
                    const className = test.class;
                    
                    allClasses.add(className);
                    
                    if (!teacherStats[teacher]) {
                        teacherStats[teacher] = {
                            name: teacher,
                            testCount: 0,
                            subjects: new Set(),
                            classes: new Set()
                        };
                    }
                    teacherStats[teacher].testCount++;
                    teacherStats[teacher].subjects.add(test.subject);
                    teacherStats[teacher].classes.add(className);
                });

                // Convert to array and sort by test count
                const rankings = Object.values(teacherStats)
                    .map(teacher => ({
                        ...teacher,
                        subjects: Array.from(teacher.subjects),
                        classes: Array.from(teacher.classes)
                    }))
                    .sort((a, b) => b.testCount - a.testCount);

                // Update stats
                document.getElementById('totalTeachers').textContent = rankings.length;
                document.getElementById('totalTests').textContent = tests.length;
                document.getElementById('totalClasses').textContent = allClasses.size;

                // Hide loading, show content
                loadingState.style.display = 'none';
                
                if (rankings.length === 0) {
                    errorState.style.display = 'flex';
                    document.getElementById('errorMessage').textContent = 'No test data available yet';
                    return;
                }

                // Display podium (top 3)
                displayPodium(rankings);
                podium.style.display = 'flex';

                // Display full rankings
                displayRankings(rankings);
                rankingsTable.style.display = 'block';

            } catch (error) {
                console.error('Failed to load leaderboard:', error);
                loadingState.style.display = 'none';
                errorState.style.display = 'flex';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        function displayPodium(rankings) {
            const positions = ['rank1', 'rank2', 'rank3'];
            
            positions.forEach((id, index) => {
                const element = document.getElementById(id);
                if (rankings[index]) {
                    const teacher = rankings[index];
                    const nameEl = element.querySelector('.podium-name');
                    const testsEl = element.querySelector('.podium-tests span');
                    const subjectsEl = element.querySelector('.podium-subjects');
                    const classesEl = element.querySelector('.podium-classes');
                    
                    nameEl.textContent = teacher.name;
                    testsEl.textContent = `${teacher.testCount} test${teacher.testCount !== 1 ? 's' : ''}`;
                    
                    // Display subjects
                    subjectsEl.innerHTML = teacher.subjects
                        .slice(0, 2)
                        .map(subject => `<span class="subject-badge">${subject}</span>`)
                        .join('');
                    
                    if (teacher.subjects.length > 2) {
                        subjectsEl.innerHTML += `<span class="subject-badge more">+${teacher.subjects.length - 2}</span>`;
                    }
                    
                    // Display classes
                    classesEl.innerHTML = teacher.classes
                        .slice(0, 3)
                        .map(className => `<span class="class-badge">${className}</span>`)
                        .join('');
                    
                    if (teacher.classes.length > 3) {
                        classesEl.innerHTML += `<span class="class-badge more">+${teacher.classes.length - 3}</span>`;
                    }
                }
            });
        }

        function displayRankings(rankings) {
            const container = document.getElementById('rankingsList');
            container.innerHTML = '';

            rankings.forEach((teacher, index) => {
                const rank = index + 1;
                const card = document.createElement('div');
                card.className = 'ranking-card';
                
                let rankBadgeClass = '';
                let rankIcon = '';
                
                if (rank === 1) {
                    rankBadgeClass = 'gold';
                    rankIcon = 'ðŸ¥‡';
                } else if (rank === 2) {
                    rankBadgeClass = 'silver';
                    rankIcon = 'ðŸ¥ˆ';
                } else if (rank === 3) {
                    rankBadgeClass = 'bronze';
                    rankIcon = 'ðŸ¥‰';
                }

                card.innerHTML = `
                    <div class="rank-badge ${rankBadgeClass}">
                        ${rankIcon ? `<span class="medal">${rankIcon}</span>` : `<span class="rank-number">#${rank}</span>`}
                    </div>
                    <div class="teacher-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="teacher-info">
                        <h3 class="teacher-name">${teacher.name}</h3>
                        <div class="teacher-subjects">
                            ${teacher.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}
                        </div>
                        <div class="teacher-classes">
                            ${teacher.classes.map(c => `<span class="class-tag">${c}</span>`).join('')}
                        </div>
                    </div>
                    <div class="teacher-stats">
                        <div class="stat-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <div>
                                <div class="stat-number">${teacher.testCount}</div>
                                <div class="stat-text">Tests</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                            <div>
                                <div class="stat-number">${teacher.subjects.length}</div>
                                <div class="stat-text">Subjects</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            <div>
                                <div class="stat-number">${teacher.classes.length}</div>
                                <div class="stat-text">Classes</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadLeaderboard);
    </script>
</body>
</html>